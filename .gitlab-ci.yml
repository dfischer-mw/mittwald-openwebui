workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

stages:
  - prepare
  - test
  - build

variables:
  REGISTRY: ghcr.io
  IMAGE_NAME: mittwald/openwebui
  MITTWALD_DEV_PORTAL: https://dev.mittwald.ai
  PUSH_TARGET: github

prepare:data:
  stage: prepare
  image: python:3.12-slim
  script:
    - set -euo pipefail
    - python -m pip install --upgrade pip
    - pip install requests beautifulsoup4
    - mkdir -p .tmp
    - |
      if [ -n "${OWUI_VERSION:-}" ]; then
        RESOLVED_VERSION="${OWUI_VERSION}"
      else
        RESOLVED_VERSION="$(python3 -c "import json, urllib.request; releases = json.load(urllib.request.urlopen('https://api.github.com/repos/open-webui/open-webui/releases?per_page=30', timeout=30)); print(next((r.get('tag_name', '') for r in releases if not r.get('draft') and not r.get('prerelease')), ''))")"
      fi

      if [ -z "${RESOLVED_VERSION}" ]; then
        echo "Failed to resolve stable Open WebUI version" >&2
        exit 1
      fi

      DATE_TAG="$(date -u +%Y%m%d)"
      if [ "${PUSH_TARGET}" = "gitlab" ]; then
        IMAGE_REF="${CI_REGISTRY_IMAGE}"
        PACKAGE_LINK="${CI_PROJECT_URL}/-/container_registry"
        PULL_LINK="${CI_REGISTRY_IMAGE}:${RESOLVED_VERSION}-${DATE_TAG}"
      else
        IMAGE_REF="${REGISTRY}/${IMAGE_NAME}"
        PACKAGE_LINK="https://github.com/orgs/mittwald/packages/container/package/openwebui"
        PULL_LINK="https://ghcr.io/v2/mittwald/openwebui/manifests/${RESOLVED_VERSION}-${DATE_TAG}"
      fi

      {
        echo "OWUI_VERSION=${RESOLVED_VERSION}"
        echo "IMAGE_REF=${IMAGE_REF}"
        echo "VERSION_TAG=${RESOLVED_VERSION}"
        echo "DATED_TAG=${RESOLVED_VERSION}-${DATE_TAG}"
        echo "PACKAGE_LINK=${PACKAGE_LINK}"
        echo "PULL_LINK=${PULL_LINK}"
      } > .tmp/ci.env

    - python3 scripts/scrape_huggingface.py > .tmp/config.json
    - python3 -c 'import json; from pathlib import Path; config = json.loads(Path(".tmp/config.json").read_text()); Path(".tmp/bootstrap.env").write_text("OWUI_BOOTSTRAP_TEMPERATURE={0}\nOWUI_BOOTSTRAP_TOP_P={1}\nOWUI_BOOTSTRAP_TOP_K={2}\nOWUI_BOOTSTRAP_REPETITION_PENALTY={3}\nOWUI_BOOTSTRAP_MAX_TOKENS={4}\n".format(config["temperature"], config["top_p"], config["top_k"], config["repetition_penalty"], config["max_tokens"]))'
    - |
      if [ -n "${MITTWALD_API_TOKEN:-}" ]; then
        python3 scripts/scrape_mittwald_portal.py "${MITTWALD_DEV_PORTAL}" -o .tmp/models.json
      else
        python3 -c 'import json; from pathlib import Path; Path(".tmp/models.json").write_text(json.dumps({"models": [], "changes": {"added": [], "removed": [], "modified": [], "has_changes": False}, "metadata": {"scraped_at": None, "portal_url": "https://dev.mittwald.ai", "model_count": 0, "note": "MITTWALD_API_TOKEN not configured; scraping skipped"}}, indent=2))'
      fi
  artifacts:
    expire_in: 1 week
    reports:
      dotenv: .tmp/ci.env
    paths:
      - .tmp/config.json
      - .tmp/bootstrap.env
      - .tmp/models.json

python:checks:
  stage: test
  image: python:3.12-slim
  script:
    - set -euo pipefail
    - python -m pip install --upgrade pip
    - pip install pytest requests beautifulsoup4
    - python3 -m py_compile scripts/*.py bootstrap/*.py
    - python3 -m pytest -q tests

build:test:publish:
  stage: build
  image: docker:27
  needs:
    - job: prepare:data
      artifacts: true
    - job: python:checks
  script:
    - set -euo pipefail
    - apk add --no-cache bash curl
    - test -f .tmp/bootstrap.env
    - test -f .tmp/models.json
    - unset DOCKER_HOST DOCKER_TLS_CERTDIR
    - docker version
    - docker build --build-arg OWUI_VERSION="${OWUI_VERSION}" -t "${IMAGE_REF}:${DATED_TAG}" .
    - chmod +x scripts/test_image.sh
    - ./scripts/test_image.sh "${IMAGE_REF}:${DATED_TAG}"
    - |
      if [ "${PUSH_IMAGE:-true}" = "true" ]; then
        if [ "${PUSH_TARGET}" = "gitlab" ]; then
          GL_REGISTRY_USER="${INTERNAL_GITLAB_REGISTRY_USER:-${GITLAB_REGISTRY_USER:-${CI_REGISTRY_USER:-}}}"
          GL_REGISTRY_PASSWORD="${INTERNAL_GITLAB_REGISTRY_PASSWORD:-${GITLAB_REGISTRY_PASSWORD:-${CI_REGISTRY_PASSWORD:-}}}"
          GL_REGISTRY_HOST="${GITLAB_REGISTRY_HOST:-${CI_REGISTRY}}"
          : "${GL_REGISTRY_USER:?Set INTERNAL_GITLAB_REGISTRY_USER or CI_REGISTRY_USER}"
          : "${GL_REGISTRY_PASSWORD:?Set INTERNAL_GITLAB_REGISTRY_PASSWORD or CI_REGISTRY_PASSWORD}"
          : "${GL_REGISTRY_HOST:?Set GITLAB_REGISTRY_HOST or CI_REGISTRY}"
          echo "${GL_REGISTRY_PASSWORD}" | docker login "${GL_REGISTRY_HOST}" -u "${GL_REGISTRY_USER}" --password-stdin
        else
          : "${GHCR_USERNAME:?Set GHCR_USERNAME CI/CD variable}"
          : "${GHCR_TOKEN:?Set GHCR_TOKEN CI/CD variable}"
          echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin
        fi

        docker tag "${IMAGE_REF}:${DATED_TAG}" "${IMAGE_REF}:${VERSION_TAG}"
        docker tag "${IMAGE_REF}:${DATED_TAG}" "${IMAGE_REF}:latest"

        docker push "${IMAGE_REF}:${DATED_TAG}"
        docker push "${IMAGE_REF}:${VERSION_TAG}"
        docker push "${IMAGE_REF}:latest"

        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE_REF}:${DATED_TAG}")
      else
        DIGEST="not-pushed"
      fi

      {
        echo "# mittwald/openwebui build result"
        echo ""
        echo "- Image: ${IMAGE_REF}"
        echo "- Tags: ${DATED_TAG}, ${VERSION_TAG}, latest"
        echo "- Digest: ${DIGEST}"
        echo "- Package link: ${PACKAGE_LINK}"
        echo "- Pull link: ${PULL_LINK}"
        echo ""
        echo "## Pull"
        echo ""
        echo "docker pull ${IMAGE_REF}:${DATED_TAG}"
      } > build-summary.md

      cat build-summary.md
  artifacts:
    expire_in: 1 week
    paths:
      - build-summary.md
      - .tmp/bootstrap.env
      - .tmp/models.json
